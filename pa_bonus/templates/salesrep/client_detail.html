{% extends "base.html" %}
{% load pa_bonus_extras %}
{% block title %}Client Detail ‚Äî {{ client.first_name }} {{ client.last_name }}{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Header -->
  <div class="page-header">
    <h2>{{ client.first_name }} {{ client.last_name }}</h2>
    <p class="page-description">
      Customer #{{ client.user_number }}
      {% if client.region %} ¬∑ Region: {{ client.region.name }}{% endif %}
      {% if client.email %} ¬∑ {{ client.email }}{% endif %}
    </p>
    <div class="dashboard-actions" style="margin-top: 1rem;">
      <a href="{% url 'salesrep_clients' %}" class="dashboard-button">
        <span class="button-text">‚Üê Back to Client List</span>
      </a>
      <a href="{% url 'salesrep_create_reward_request' client.pk %}" class="dashboard-button">
        <span class="button-icon">üéÅ</span>
        <span class="button-text">Create Reward Request</span>
      </a>
    </div>
  </div>

  <!-- Points Summary -->
  <div class="dashboard-section">
    <h3>Points Summary</h3>
    <div class="summary-stats">
      <div class="stat-card">
        <span class="stat-value">{{ point_totals.available }}</span>
        <span class="stat-label">Available Balance</span>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ point_totals.period_confirmed }}</span>
        <span class="stat-label">Confirmed (Period)</span>
      </div>
    </div>
  </div>

  <!-- Date Filter -->
  <div class="filter-bar">
    <form method="get">
      <div class="filter-row">
        <div class="filter-group">
          <label for="month_from">From</label>
          <select name="month_from" id="month_from">
            {% for num, name in months %}
              <option value="{{ num }}" {% if month_from == num %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label for="year_from">Year</label>
          <select name="year_from" id="year_from">
            {% year_range 2024 2030 as years %}
            {% for y in years %}
              <option value="{{ y }}" {% if year_from == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label for="month_to">To</label>
          <select name="month_to" id="month_to">
            {% for num, name in months %}
              <option value="{{ num }}" {% if month_to == num %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label for="year_to">Year</label>
          <select name="year_to" id="year_to">
            {% year_range 2024 2030 as years %}
            {% for y in years %}
              <option value="{{ y }}" {% if year_to == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <button type="submit" class="btn-filter">Filter</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Contract Info -->
  <div class="dashboard-section">
    <h3>Contract</h3>
    {% if active_contract %}
      <p>Active contract: {{ active_contract.contract_date_from|date:"d.m.Y" }} ‚Äì {{ active_contract.contract_date_to|date:"d.m.Y" }}</p>
    {% else %}
      <p>No active contract.</p>
    {% endif %}
  </div>

  <!-- Brand Turnovers -->
  <div class="dashboard-section">
    <h3>Brand Turnovers ({{ date_from|date:"d.m.Y" }} ‚Äì {{ date_to|date:"d.m.Y" }})</h3>
    <div class="table-container">
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Brand</th>
            <th>Invoice Turnover</th>
            <th>Credit Notes</th>
            <th>Net Turnover</th>
            <th>Points</th>
            <th>In Contract</th>
          </tr>
        </thead>
        <tbody>
          {% for data in brand_turnovers %}
          <tr class="{% if data.in_contract %}contract-brand{% endif %}">
            <td>{{ data.brand.name }}</td>
            <td>{{ data.invoice_turnover|floatformat:2 }} PLN</td>
            <td>{{ data.credit_turnover|floatformat:2 }} PLN</td>
            <td>{{ data.net_turnover|floatformat:2 }} PLN</td>
            <td class="value {% if data.points < 0 %}negative{% else %}positive{% endif %}">
              {{ data.points }} pts
            </td>
            <td>
              {% if data.in_contract %}
                <span class="status-badge confirmed">Yes</span>
              {% else %}
                <span class="status-badge pending">No</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6">No turnover data found for the selected period.</td>
          </tr>
          {% endfor %}
          {% if brand_turnovers %}
          <tr class="summary-row">
            <td><strong>TOTAL</strong></td>
            <td>{{ brand_turnovers|sum_attr:"invoice_turnover"|floatformat:2 }} PLN</td>
            <td>{{ brand_turnovers|sum_attr:"credit_turnover"|floatformat:2 }} PLN</td>
            <td>{{ brand_turnovers|sum_attr:"net_turnover"|floatformat:2 }} PLN</td>
            <td class="value"><strong>{{ brand_turnovers|sum_attr:"points" }} pts</strong></td>
            <td></td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="dashboard-section">
    <h3>Recent Point Transactions</h3>
    <div class="table-container">
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Brand</th>
            <th>Description</th>
            <th>Points</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in recent_transactions %}
          <tr>
            <td>{{ transaction.date|date:"d.m.Y" }}</td>
            <td>{{ transaction.brand.name|default:"N/A" }}</td>
            <td>{{ transaction.description }}</td>
            <td class="value {% if transaction.value < 0 %}negative{% else %}positive{% endif %}">
              {{ transaction.value }} pts
            </td>
            <td>
              <span class="status-badge {{ transaction.status|lower }}">{{ transaction.get_status_display }}</span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5">No recent transactions found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Reward Requests -->
  <div class="dashboard-section">
    <h3>Reward Requests</h3>
    <div class="table-container">
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Points</th>
            <th>Status</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for req in reward_requests %}
          <tr>
            <td>{{ req.requested_at|date:"d.m.Y" }}</td>
            <td class="value negative">{{ req.total_points }} pts</td>
            <td>
              <span class="status-badge {{ req.status|lower }}">{{ req.get_status_display }}</span>
            </td>
            <td>
              {% if req.note %}
                <span class="note-indicator" title="{{ req.note|truncatechars:50 }}">‚úì</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4">No reward requests found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
