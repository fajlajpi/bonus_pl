{% extends 'base.html' %}
{% load pa_bonus_extras %}

{% block title %}
  {% if request.status == 'DRAFT' %}
  Potwierdzenie wniosku o realizację
  {% else %}
  Szczegóły wniosku o realizację
  {% endif %}
{% endblock title %}

{% block content %}
  {% if request.status == 'DRAFT' %}
    <h1>Potwierdzenie wniosku o realizację</h1>
    <div class="intro-text">
      <p>Sprawdź poniższe informacje i jeśli są poprawne, potwierdź wniosek przyciskiem na dole strony.</p>
    </div>
  {% else %}
    <h1>Szczegóły wniosku o realizację</h1>
    <div class="intro-text">
      <p>Poniżej znajdziesz informacje o złożonym wniosku o bonus w ramach programu.</p>
    </div>
  {% endif %}

  <p>Użytkownik: {{ request.user.username }}</p>
  <p>Data wniosku: {{ request.requested_at|czech_date }}</p>
  <p>Łączna wartość: {{ request.total_points }} bodů</p>

  <h2>Pozycje:</h2>
  <ul>
    {% for item in items %}
      <li>
        {{ item.quantity }} x {{ item.reward.name }} ({{ item.point_cost }} pkt / szt.) = {{ item.quantity|multiply:item.point_cost }} pkt łącznie
      </li>
    {% endfor %}
  </ul>

  {% if request.status == 'DRAFT' %}
    <p>Twoje dostępne punkty: {{ user_balance }}</p>
    {% if request.total_points <= user_balance %}
        <form method="post">
          {% csrf_token %}
          
          <div class="form-group">
            <label for="customer_note"><strong>Uwagi do wniosku:</strong></label>
            <textarea name="customer_note" id="customer_note" rows="4" style="width: 100%;">{{ request.note }}</textarea>
            <p class="help-text">Tutaj możesz podać adres dostawy (jeśli jest inny niż adres rejestrowy), preferowany termin dostawy lub inne uwagi dotyczące zamówienia.</p>
          </div>
          
          <button class="submit-button" type="submit">Potwierdź wniosek o nagrodę</button>
        </form>
    {% else %}
        <p>Nie masz wystarczającej liczby punktów, aby złożyć wniosek.</p>
    {% endif %}
{% else %}
    {% if request.note %}
    <h2>Uwagi do wniosku:</h2>
    <div class="note-container">
      {{ request.note }}
    </div>
    {% endif %}
    
    {% if request.description %}
    <h2>Uwagi od menedżera:</h2>
    <div class="note-container">
      {{ request.description }}
    </div>
    {% endif %}
    
    {% if request.status == 'PENDING' %}
        <div class="status-info pending">
            <h3>Status wniosku: Oczekuje na potwierdzenie</h3>
            <p>Twój wniosek został wysłany i oczekuje na zatwierdzenie przez menedżera. Standardowy czas przetwarzania to 1–3 dni robocze.</p>
        </div>
    {% elif request.status == 'ACCEPTED' %}
        <div class="status-info accepted">
            <h3>Status wniosku: Zatwierdzony</h3>
            <p>Twój wniosek został zatwierdzony i jest gotowy do realizacji. Nagrody wysyłamy w zależności od dostępności magazynowej.</p>
            <p>W razie pytań skontaktuj się ze swoim opiekunem handlowym.</p>
        </div>
    {% elif request.status == 'REJECTED' %}
        <div class="status-info rejected">
            <h3>Status wniosku: Odrzucony</h3>
            <p>Niestety Twój wniosek został odrzucony. Powód znajdziesz w uwagach od menedżera powyżej.</p>
            <p>Aby uzyskać więcej informacji, skontaktuj się ze swoim opiekunem handlowym lub złóż nowy wniosek.</p>
        </div>
    {% elif request.status == 'FINISHED' %}
        <div class="status-info finished">
            <h3>Status wniosku: Zrealizowany</h3>
            <p>Twój wniosek został pomyślnie zrealizowany, a nagrody zostały wysłane. Dziękujemy za korzystanie z naszego programu bonusowego.</p>
        </div>
    {% elif request.status == 'CANCELLED' %}
        <div class="status-info cancelled">
            <h3>Status wniosku: Anulowany</h3>
            <p>Ten wniosek został anulowany. Twoje punkty zostały zwrócone na konto punktowe.</p>
            <p>Aby złożyć nowy wniosek, wróć do <a href="{% url 'rewards' %}">sekcji nagród</a>.</p>
        </div>
    {% endif %}
{% endif %}

  <style>
    .hidden{
      display: none;
    }
    .note-container {
      background-color: var(--neutral-bg);
      padding: 1rem;
      border-radius: var(--border-radius-md);
      margin-bottom: 1.5rem;
    }
    .help-text {
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.25rem;
    }
  </style>
{% endblock %}