{% extends 'base.html' %}
{% load static %}
{% block title %} Oferta nagród {% endblock title %}
{% block content %}
  <h1>Dostępne nagrody:</h1>
  <div class="points-summary">
    <h3>Aktualny stan konta punktowego</h3>
    <p class="total-points">{{ user_balance }} pkt</p>
  </div>
  <div class="intro-text">
    <p>Oferta Programu Bonusowego może ulegać zmianom w zależności od dostępności nagród u nas i u dostawców. Nagrody oznaczone 
      <span class="availability-badge available">sklaw magazynie</span> są zazwyczaj dostępne od ręki. Nagrody oznaczone
    <span class="availability-badge on_demand">na zamówienie</span> zamawiamy dopiero na podstawie Twojego wniosku.</p>
    <p>W razie pytań skontaktuj się z nami e-mailem <a href="mailto:support@bonus.primavera-and.cz">bonus@primavera-and.cz</a>, 
      lub zwróć się do swojego opiekuna handlowego.</p>
    <p>Obecnie finalizujemy dodawanie pełnej oferty — niektórych nagród może jeszcze brakować.</p>
  </div>
  <form method="post">
    {% csrf_token %}
{% if rewards %}
  <div class="table-container">
    <table class="rewards-table">
      <thead>
        <tr>
          <th class="reward-image-col">Produkt</th>
          <th class="reward-info-col">Informacje</th>
          <th class="reward-cost-col">Punkty</th>
          <th class="reward-status-col">Dostępność</th>
          <th class="reward-quantity-col">Ilość</th>
        </tr>
      </thead>
      <tbody>
        {% for reward in rewards %}
          <tr>
            <td class="reward-image-cell">
              {% if reward.image %}
                <img src="{{ reward.image.url }}" alt="{{ reward.name }}" class="reward-image">
              {% else %}
                <img src="{% static 'images/default.png' %}" alt="Default Image" class="reward-image">
              {% endif %}
            </td>
            <td class="reward-info-cell">
              <h3 class="reward-name">{{ reward.name }}</h3>
              <p class="reward-description">{{ reward.description }}</p>
              <div class="reward-metadata">
                <span class="reward-code">Kod: {{ reward.abra_code }}</span>
              </div>
            </td>
            <td class="reward-cost-cell">
              <div class="point-cost">{{ reward.point_cost }}</div>
              <div>pkt</div>
            </td>
            <td class="reward-status-cell">
              <span class="availability-badge {{ reward.availability|lower }}">
                {% if reward.availability == 'AVAILABLE' %}
                  W magazynie
                {% elif reward.availability == 'AVAILABLE_LAST_UNITS' %}
                  W magazynie — ostatnie sztuki
                {% elif reward.availability == 'ON_DEMAND' %}
                  Na zamówienie
                {% elif reward.availability == 'UNAVAILABLE' %}
                  Niedostępne
                {% endif %}
              </span>
            </td>
            <td class="reward-quantity-cell">
              {% if reward.availability != 'UNAVAILABLE' %}
                <div class="quantity-input">
                  <input class="reward-input" type="number" name="reward_quantity_{{ reward.id }}" id="reward_quantity_{{ reward.id }}" value="0" min="0" 
                         {% if reward.availability == 'UNAVAILABLE' %}disabled{% endif %}>
                </div>
              {% else %}
                <div class="quantity-input">
                  <input class="reward-input" type="number" name="reward_quantity_{{ reward.id }}" id="reward_quantity_{{ reward.id }}" value="0" min="0" disabled>
                </div>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Live summary of total point cost -->
  <div id="live-total-container" class="points-summary" style="margin-top: 2rem;">
    <h3>Łączna wartość wniosku</h3>
    <span class="total-points" id="live-total">0 pkt</span> <span class="total-points">/ {{ user_balance }} dostępnych</span>
    <p id="point-warning" style="display:none; color: var(--error-color); font-weight: bold;">Przekroczono stan konta punktowego!</p>
  </div>
  
  <button id="submit-button" class="submit-button" type="submit">Złóż wniosek o nagrody</button>
{% else %}
  <p>W tej chwili nie ma żadnych dostępnych nagród.</p>
{% endif %}
  </form>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const inputs = document.querySelectorAll('.reward-input');
      const totalDisplay = document.getElementById('live-total');
      const warningText = document.getElementById('point-warning');
      const submitButton = document.getElementById('submit-button');
  
      const userBalance = {{ user_balance|default:0 }};  // Injected from Django context
      let currentTotal = 0;
  
      function calculateTotal() {
        currentTotal = 0;
        inputs.forEach(input => {
          if (!input.disabled) {
            const quantity = parseInt(input.value) || 0;
            const pointCost = parseInt(input.closest('tr').querySelector('.point-cost').textContent);
            currentTotal += quantity * pointCost;
          }
        });
  
        totalDisplay.textContent = currentTotal + ' bodů';
  
        if (currentTotal > userBalance) {
          warningText.style.display = 'block';
          submitButton.disabled = true;
          submitButton.style.opacity = 0.6;
          submitButton.style.pointerEvents = 'none';
        } else {
          warningText.style.display = 'none';
          submitButton.disabled = false;
          submitButton.style.opacity = 1;
          submitButton.style.pointerEvents = 'auto';
        }
      }
  
      inputs.forEach(input => {
        input.addEventListener('input', calculateTotal);
      });
  
      calculateTotal();  // initialize on load
    });
  </script>
{% endblock %}